---
tags:
  - book
  - TDD
  - coding
---

古風な環境で働いているため、テストコードを書くという文化が未だにない。  
今更ながらテスト駆動開発について学ぶべく、コレを読みました。

# 感想
テスト駆動開発のノウハウや考え方について述べられているが、本書と付録を通して、
- テスト駆動開発の「テスト」は品質保証のためのソフトウェアテストではない。
- 設計を導く手段であり、言い換えるならBehavior駆動開発(BDD)
- BDDに基づいて作られたフレームワークがRSpec, Cucumberなど(用語の置換等)
- Mockなどテストの道具も全体的に当初の意味・用途から外れて用いられている
- TDDは組織としてのソフトウェアテストの仕組ではなく、個人のコーディングを導くツール  
  明日からでも導入できる（環境を制約されていなければ・・・）

など、「テスト駆動開発という開発ツールの(当初の)使い所」が繰り返し書かれている。  
特に付録の訳者解説ではテスト駆動開発の起こりから現在までの変遷がまとめられていて自分や周りの人が「テスト駆動やろう」と言い出したときに、何を目的とするかか考えるキッカケになりそう。

テスト駆動開発自体は、総じて求められるレベルが高いと思う。  
「個人の設計ツール」として導入するのは良いが、チームで取り組もうと思うとレベルの高い現場でないと厳しい。  
ただ、TDD導入とまでいかなくとも、第1部「多国籍通貨」の写経だけでもしてもらうと全体のレベルが上がりそう。  
「テストできる実装」を意識するようになると、実装も設計もだいぶ質が上がると思う。

# 書籍の概要
- 1部：多国籍通貨（Java)  
簡単な通貨換算が必要な通貨同士の加算・乗算の昨日をテスト駆動で実装する。
- 2部：xUnit（Python)  
簡単なテストフレームワークを、それ自身でテストしながら実装する。  
- 3部：テスト駆動開発について  
どう進めるか、どういうテストをするか、どういう道具(デザインパターン等)があるか、等のテスト駆動開発の考え方について。

「テスト駆動開発」の本だが、先に書いたとおり、テスト駆動は設計・リファクタリングを正しく導くことが目的。  
1部、2部の内容はテストコードの追加、機能実装、リファクタリングの繰り返しで進む。オブジェクト志向、デザパタなど駆使して「キレイな動作するコード」を作っていくので、それらの実践練習としてとても良い。オブジェクト志向やデザパタについて細かく解説されているわけではないが、他の書籍などで学んだ状態から理解度を深めるのに役立つと思う。

あまり書籍の詳細を書くのも良くないと思うので、以下はキーワードと簡単な解説の羅列、所感など。

---
# テスト駆動について
## レッド・グリーン・リファクタリング
テスト駆動開発の基本サイクル。  
期待する挙動のテストコードを書き(テストファースト)、動く実装をして、リファクタリングで一般化する。  
テスト、実装、リファクタリングを常に1歩ずつ進めるべし。  
複数機能をまとめて実装しない。何箇所もまとめてリファクタリングしない。書いたらテストを走らせる。  
というのが基本的な進め方だが、本書中でもステップの小ささは人や状況に寄るので加減してね、とのこと。  
誰が見ても明らかで確認するまでもないような実装は、そのまま進めればいい。不安があればテストする。


## テスト駆動を助ける小道具
### 仮実装と明白な実装
- 仮実装：べた書きの値を使ってとにかく動く実装をする
- 明白な実装：頭の中の実装をコードに落とす

テストを通る実装をする際、明確な答えがすぐ浮かぶならそれで良い（明白な実装）。  
そうでないなら、べた書きの値でもなんでも、とにかく動く実装（仮実装）をして、リファクタリングする。

### 三角測量
リファクタリング時に一般化方法が浮かばない場合、2つ以上のテストを書いてからから実装を一般化する。  
(例：2つのテスト(`$5 == $5`と`$5 != $6`)からequalsを一般化する方法を考える)  

### テストケースの書き方
- 「こうなったらいい」と思うケースを書き、一歩で動かせるところまで後退させる
- 一般化は末端の実装から始め、テストケースまで到達させる
- 「何をテストしたいか」後の読み手に分かりやすいケースを書く
- アサートファースト：最終的に期待することを最初に書く
- 明示的なテストコード：文脈が分かるように書く  
  例として、100円の商品の税込み価格を確認するなら  
  △：`assertEquals(108, amount)`  
  ○：`assertEquals(100 * 1.08, amount)`

### 実装の進め方
- 実装に詰まったらテストが通った時点まで戻して再変更、再テスト。  
- 複雑な仕様を実装するために途中段階のための簡単なテストを作る。  
(`$5 + 10CHF = $10`を実装するために`$5 + $5 = $10`を実装する等)
- テストを通す最低限の実装をして、その時点で不要なものはToDoリストに入れる。

## その他
### TDDの普及のために
あなたがTDDを行っているなら、不具合が少なく設計がシンプルで説明しやすいことがチームに伝わるはず。  
TDDを強制するべきではない(TDD自体は品質保証の仕組ではなく、個人用の設計ツールなので強制力はないはず)
要するにまず自分で実践して、結果で魅力を示すべし。  

### 途中からTDDに乗り換えるには
テストを考えずに作られたコードは、そもそも処理が独立しておらずテストが書けない。  
テストなきリファクタリングには失敗が待っている。テストとリファクタリングのデッドロック。鶏と卵問題。  

変えなくていいなら変えない。お金を生まないならコストを掛けるべきではない。  
必要なとき、必要な箇所に対して、ペアプロや機能レベルのテストを行いながら慎重にリファクタリングする。  
それを繰り返す内に、頻繁に変更が発生する箇所はTDDに近づいていくはず。

### デザインパターン
デザパタは、様々な問題に対してプログラマが共有している一般的な解法、としている。  
頻出問題の解き方のパターンを全員が知っていれば、誰が解いても同じ解答になるよね、ということ。  
本書ではデザパタを網羅的に説明しているわけではないので本記事では割愛。  

上記の他にもリファクタリングのノウハウなど細かい技法や考え方がサンプルコードや第1部、2部に沿って解説されている。  
最初にも書いたが、TDDの理論だけでなくリファクタリングの練習問題集として(コード量は多くないが)とても良い。  
TDDへの興味の有無に関わらず、オブジェクト指向言語で開発に携わっているのであれば、読んで損はない良書。  
会社の本を借りて読んだが、手元に欲しいので買いましたｗ